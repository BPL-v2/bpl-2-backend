DELETE FROM characters WHERE "name" = '';

CREATE TABLE characters2 (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    event_id BIGINT NOT NULL REFERENCES events(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    level INT NOT NULL,
    main_skill VARCHAR(255) NOT NULL,
    ascendancy VARCHAR(255) NOT NULL,
    ascendancy_points INT NOT NULL,
    atlas_points INT NOT NULL,
    pantheon BOOLEAN NOT NULL
);

CREATE INDEX idx_characters2_user_id ON characters2 (user_id);
CREATE INDEX idx_characters2_event_id ON characters2 (event_id);


INSERT INTO characters2 (user_id, event_id, name, level, main_skill, ascendancy, ascendancy_points, atlas_points, pantheon)
SELECT user_id, event_id, name, level, main_skill, ascendancy, ascendancy_points, atlas_node_count, pantheon
FROM (
    SELECT *, 
           ROW_NUMBER() OVER (PARTITION BY name ORDER BY timestamp DESC) as rn
    FROM characters
) ranked
WHERE rn = 1;


CREATE TABLE character_stats (
   "time" TIMESTAMPTZ,
   event_id BIGINT NOT NULL REFERENCES events(id) ON DELETE CASCADE,
   character_id BIGINT NOT NULL REFERENCES characters2(id) ON DELETE CASCADE,
   dps INTEGER NOT NULL,
   ehp INTEGER NOT NULL,
   phys_max_hit INTEGER NOT NULL,
   ele_max_hit INTEGER NOT NULL,
   hp INTEGER NOT NULL,
   mana INTEGER NOT NULL,
   es INTEGER NOT NULL,
   armour INTEGER NOT NULL,
   evasion INTEGER NOT NULL,
   xp BIGINT NOT NULL
) WITH (
  tsdb.hypertable,
  tsdb.partition_column='time',
  tsdb.segmentby='event_id', 
  tsdb.orderby='time DESC'
);

CREATE UNIQUE INDEX idx_eventid_time
  ON character_stats(event_id, time);
CREATE UNIQUE INDEX idx_character_time
  ON character_stats(character_id, time);


INSERT INTO character_stats (
  time, event_id, character_id, xp, dps, ehp, phys_max_hit, ele_max_hit, 
  hp, mana, es, armour, evasion
) 
SELECT 
  "timestamp", c.event_id, c2.id, 
  CASE c."level"
    WHEN 1 THEN 0
    WHEN 2 THEN 525
    WHEN 3 THEN 1760
    WHEN 4 THEN 3781
    WHEN 5 THEN 7184
    WHEN 6 THEN 12186
    WHEN 7 THEN 19324
    WHEN 8 THEN 29377
    WHEN 9 THEN 43181
    WHEN 10 THEN 61693
    WHEN 11 THEN 85990
    WHEN 12 THEN 117506
    WHEN 13 THEN 157384
    WHEN 14 THEN 207736
    WHEN 15 THEN 269997
    WHEN 16 THEN 346462
    WHEN 17 THEN 439268
    WHEN 18 THEN 551295
    WHEN 19 THEN 685171
    WHEN 20 THEN 843709
    WHEN 21 THEN 1030734
    WHEN 22 THEN 1249629
    WHEN 23 THEN 1504995
    WHEN 24 THEN 1800847
    WHEN 25 THEN 2142652
    WHEN 26 THEN 2535122
    WHEN 27 THEN 2984677
    WHEN 28 THEN 3496798
    WHEN 29 THEN 4080655
    WHEN 30 THEN 4742836
    WHEN 31 THEN 5490247
    WHEN 32 THEN 6334393
    WHEN 33 THEN 7283446
    WHEN 34 THEN 8384398
    WHEN 35 THEN 9541110
    WHEN 36 THEN 10874351
    WHEN 37 THEN 12361842
    WHEN 38 THEN 14018289
    WHEN 39 THEN 15859432
    WHEN 40 THEN 17905634
    WHEN 41 THEN 20171471
    WHEN 42 THEN 22679999
    WHEN 43 THEN 25456123
    WHEN 44 THEN 28517857
    WHEN 45 THEN 31897771
    WHEN 46 THEN 35621447
    WHEN 47 THEN 39721017
    WHEN 48 THEN 44225461
    WHEN 49 THEN 49176560
    WHEN 50 THEN 54607467
    WHEN 51 THEN 60565335
    WHEN 52 THEN 67094245
    WHEN 53 THEN 74247659
    WHEN 54 THEN 82075627
    WHEN 55 THEN 90631041
    WHEN 56 THEN 99984974
    WHEN 57 THEN 110197515
    WHEN 58 THEN 121340161
    WHEN 59 THEN 133497202
    WHEN 60 THEN 146749362
    WHEN 61 THEN 161191120
    WHEN 62 THEN 176922628
    WHEN 63 THEN 194049893
    WHEN 64 THEN 212684946
    WHEN 65 THEN 232956711
    WHEN 66 THEN 255001620
    WHEN 67 THEN 278952403
    WHEN 68 THEN 304972236
    WHEN 69 THEN 333233648
    WHEN 70 THEN 363906163
    WHEN 71 THEN 397194041
    WHEN 72 THEN 433312945
    WHEN 73 THEN 472476370
    WHEN 74 THEN 514937180
    WHEN 75 THEN 560961898
    WHEN 76 THEN 610815862
    WHEN 77 THEN 664824416
    WHEN 78 THEN 723298169
    WHEN 79 THEN 786612664
    WHEN 80 THEN 855129128
    WHEN 81 THEN 929261318
    WHEN 82 THEN 1009443795
    WHEN 83 THEN 1096169525
    WHEN 84 THEN 1189918242
    WHEN 85 THEN 1291270350
    WHEN 86 THEN 1400795257
    WHEN 87 THEN 1519130326
    WHEN 88 THEN 1646943474
    WHEN 89 THEN 1784977296
    WHEN 90 THEN 1934009687
    WHEN 91 THEN 2094900291
    WHEN 92 THEN 2268549086
    WHEN 93 THEN 2455921256
    WHEN 94 THEN 2658074992
    WHEN 95 THEN 2876116901
    WHEN 96 THEN 3111280300
    WHEN 97 THEN 3364828162
    WHEN 98 THEN 3638186694
    WHEN 99 THEN 3932818530
    WHEN 100 THEN 4250334444
    ELSE 0
  END,0, 0, 0, 0, 0, 0, 0, 0, 0
FROM characters c
JOIN characters2 c2 ON c.name = c2.name;

ALTER TABLE characters RENAME TO characters_old;
ALTER TABLE characters2 RENAME TO characters;
